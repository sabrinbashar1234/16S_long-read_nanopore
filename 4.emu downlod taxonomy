##script for emu
# one-time install

module --force purge
module load StdEnv/2023 python/3.10

# Create and activate a virtualenv for Emu
python -m venv /home/sbashar/scratch/emu_env
source /home/sbashar/scratch/emu_env/bin/activate

pip install --no-cache-dir emu==3.4.5  # or latest 3.x [web:244][web:250]

##then download prebuilt database (ex SILVA)

pip install --no-cache-dir osfclient

export EMU_DATABASE_DIR=/project/def-kozyrsky/sbashar/emu_db_silva
mkdir -p "$EMU_DATABASE_DIR"
cd "$EMU_DATABASE_DIR"

export EMU_PREBUILT_DB='silva'
osf -p 56uf7 fetch osfstorage/emu-prebuilt/${EMU_PREBUILT_DB}.tar
tar -xvf ${EMU_PREBUILT_DB}.tar


##PREPARE LIST OF FASTQ
cd "/home/sbashar/scratch/16S/16S Stability Study/1st_run/qc_q8"
ls BC*.qc_q8.fastq.gz | sort > emu_fastq_list.txt
mkdir -p ../taxonomy_emu ../logs


##sbatch script
#!/bin/bash
#SBATCH --job-name=emu16S
#SBATCH --account=def-kozyrsky             # <-- confirm account
#SBATCH --time=24:00:00
#SBATCH --cpus-per-task=8
#SBATCH --mem=64G
#SBATCH --array=1-12                       # 12 samples in 1st_run
#SBATCH --output=logs/emu_%A_%a.out
#SBATCH --error=logs/emu_%A_%a.err

module --force purge
module load StdEnv/2023 python/3.10

# Activate the Emu environment
source /home/sbashar/scratch/emu_env/bin/activate

EMU_DB=/project/def-kozyrsky/sbashar/emu_db_silva   # path from step 1

cd "/home/sbashar/scratch/16S/16S Stability Study/1st_run"

FILE=$(sed -n "${SLURM_ARRAY_TASK_ID}p" qc_q8/emu_fastq_list.txt)
BASENAME=$(basename "${FILE}" .fastq.gz)

mkdir -p taxonomy_emu

emu abundance \
  --db "${EMU_DB}" \
  --type map-ont \
  --threads ${SLURM_CPUS_PER_TASK} \
  --output taxonomy_emu/${BASENAME} \
  "${FILE}"


##run it
sbatch 03_emu_taxonomy.slurm


###Merge all abundance table

#!/bin/bash
#SBATCH --job-name=merge_emu
#SBATCH --output=logs/merge_emu.out
#SBATCH --error=logs/merge_emu.err
#SBATCH --time=01:00:00
#SBATCH --cpus-per-task=1
#SBATCH --mem=4G

TAX_DIR=/home/sbashar/scratch/16S/taxonomy
OUT=/home/sbashar/scratch/16S/taxonomy/combined_abundance.tsv

module load python/3.10

python3 << 'EOF'
import glob
import pandas as pd

files = sorted(glob.glob(f"{TAX_DIR}/BC*/abundance.tsv"))
dfs = []

for f in files:
    sample = f.split("/")[-2]
    df = pd.read_csv(f, sep="\t")
    df = df[["name", "abundance"]]
    df.rename(columns={"abundance": sample}, inplace=True)
    dfs.append(df)

merged = dfs[0]
for df in dfs[1:]:
    merged = merged.merge(df, on="name", how="outer")

merged.fillna(0, inplace=True)
merged.to_csv("${OUT}", sep="\t", index=False)
EOF

##run it
sbatch 04_merge_taxonomy.sbatch
